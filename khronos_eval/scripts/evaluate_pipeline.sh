#!/bin/bash

# ========== Params ==========
experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/khronos/office_kimera_tmp" # Which experiment to evaluate.
evaluation_config=$(rospack find khronos_eval)/config/pipeline/office.yaml           # Which evaluation config to use.
force_recompute=true                                                                 # Force recomputation if output or results already exist.
only_evaluate_final_map=false                                                        # Only evaluate the final map.
# ========== What to run ==========
run_pipeline=true
run_evaluation=true
run_plotting=true

# ========== Params can be supplied as arguments ==========
if [ -n "$1" ]; then
    experiment_dir=$1
fi
if [ -n "$2" ]; then
    evaluation_config=$2
fi
if [ -n "$3" ]; then
    force_recompute=$3
fi
if [ -n "$4" ]; then
    only_evaluate_final_map=$4
fi

# ========== Autogenerated arguments ==========
exec_dir=$(catkin_find --first-only --without-underlays --libexec khronos_eval)
if [[ $exec_dir == "" ]]; then
    echo "Could not find executable directory. Did you source the workspace?"
    exit 1
fi
src_dir=$(rospack find khronos_eval)
if [[ $src_dir == "" ]]; then
    echo "Could not find source directory. Did you source the workspace?"
    exit 1
fi

# ========== Functions ==========
function evaluate {
    if [ $run_evaluation == true ] || [ $run_pipeline == true ]; then
        echo "---------- Evaluation ----------"
        eval $exec_dir/exp_pipeline $evaluation_config $experiment_dir $force_recompute $run_pipeline $run_evaluation $only_evaluate_final_map
    fi
    if [[ $run_plotting == true ]]; then
        echo "---------- Plotting ----------"
        echo "----- Reconciliation -----"
        $src_dir/plotting/plot_reconciliation.py -e $experiment_dir
        echo "----- Objects -----"
        $src_dir/plotting/plot_objects.py -e $experiment_dir -c $evaluation_config
    fi
}
# ========== Run Evaluation ==========
# evaluate

# ---- Khronos ----
evaluation_config=$(rospack find khronos_eval)/config/pipeline/apartment.yaml
experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/khronos/apartment_kimera"
evaluate

# evaluation_config=$(rospack find khronos_eval)/config/pipeline/apartment.yaml
# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/khronos/apartment_kimera"
# evaluate

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/khronos/office_gt"
# evaluate

# evaluation_config=$(rospack find khronos_eval)/config/pipeline/apartment.yaml

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/khronos/apartment_kimera"
# evaluate

# # ---- Hydra ----
# run_pipeline=false
# evaluation_config=$(rospack find khronos_eval)/config/pipeline/hydra_office.yaml

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/hydra/office_kimera"
# evaluate

# evaluation_config=$(rospack find khronos_eval)/config/pipeline/hydra_apartment.yaml
# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/hydra/apartment_kimera"
# evaluate

# ---- Panoptic Mapping ----
# run_pipeline=false
# evaluation_config=$(rospack find khronos_eval)/config/pipeline/pm_apartment.yaml

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/pm_test/apartment_kimera"
# evaluate

# evaluation_config=$(rospack find khronos_eval)/config/pipeline/pm_office.yaml
# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/pm_test/office_gt"
# evaluate

# ---- Dynablox ----
# run_pipeline=false
# evaluation_config=$(rospack find khronos_eval)/config/pipeline/dynablox.yaml

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/dynablox/apartment_kimera"
# evaluate

# experiment_dir="/mnt/c/Users/DerFu/Documents/khronos/data/dynablox/office_kimera"
# evaluate
